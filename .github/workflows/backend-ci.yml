name: Backend CI

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'backend/**'

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore
      working-directory: backend

    - name: ðŸ—ï¸ Build
      run: dotnet build --configuration Release --no-restore
      working-directory: backend

    - name: ðŸ§ª Run tests
      run: dotnet test --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"
      working-directory: backend

    - name: ðŸ“Š Publish test results
      uses: dorny/test-reporter@v1
      if: always()
      continue-on-error: true
      with:
        name: Backend Test Results
        path: backend/**/test-results.trx
        reporter: dotnet-trx
        fail-on-error: false

    - name: âœ… Build Summary
      if: success()
      run: |
        echo "### âœ… Backend CI Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Build successful" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… All tests passed" >> $GITHUB_STEP_SUMMARY

    - name: âŒ Build Failed
      if: failure()
      run: |
        echo "### âŒ Backend CI Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
        exit 1
