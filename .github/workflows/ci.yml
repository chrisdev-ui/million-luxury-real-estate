name: CI - Full Stack

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  backend:
    name: Backend CI
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore
      working-directory: backend

    - name: ðŸ—ï¸ Build
      run: dotnet build --configuration Release --no-restore
      working-directory: backend

    - name: ðŸ§ª Run tests
      run: dotnet test --configuration Release --no-build --verbosity normal
      working-directory: backend

  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ðŸ“¦ Install dependencies
      run: npm ci
      working-directory: frontend

    - name: ðŸ” Run linter
      run: npm run lint
      working-directory: frontend

    - name: ðŸ—ï¸ Build
      run: npm run build
      working-directory: frontend
      env:
        NEXT_PUBLIC_API_URL: http://localhost:5208

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: always()

    steps:
    - name: âœ… All Checks Passed
      if: needs.backend.result == 'success' && needs.frontend.result == 'success'
      run: |
        echo "### âœ… All CI Checks Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Backend**: Build and tests passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Frontend**: Lint and build passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ Ready to merge!" >> $GITHUB_STEP_SUMMARY

    - name: âŒ Some Checks Failed
      if: needs.backend.result != 'success' || needs.frontend.result != 'success'
      run: |
        echo "### âŒ CI Checks Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.backend.result }}" != "success" ]; then
          echo "âŒ **Backend**: Failed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **Backend**: Passed" >> $GITHUB_STEP_SUMMARY
        fi
        if [ "${{ needs.frontend.result }}" != "success" ]; then
          echo "âŒ **Frontend**: Failed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **Frontend**: Passed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âš ï¸ Please fix the issues before merging." >> $GITHUB_STEP_SUMMARY
        exit 1
